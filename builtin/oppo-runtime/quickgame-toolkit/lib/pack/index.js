"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r.default=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function checkSubpackageConf(e,r){var t={};r.subpackages.forEach(function(r){if(r.name&&r.root)if(t[r.name])console.log(_chalk2.default.red("[配置错误]分包名重复： "+r.name)),_shelljs2.default.exit(1);else if(r.name==CONFIG.MAIN_PACK_NAME)console.log(_chalk2.default.red("[配置错误]分包名称不能为main： ["+r.name+"]")),_shelljs2.default.exit(1);else{var a=_path2.default.resolve(e,r.root);if(_fsExtra2.default.existsSync(a)){var l=_fsExtra2.default.statSync(a);l.isDirectory()?t[r.name]=r:".js"===_path2.default.extname(r.root)?t[r.name]=r:(console.log(_chalk2.default.red("[配置错误]分包["+r.name+"] root必须是目录或者.js文件")),_shelljs2.default.exit(1))}else console.log(_chalk2.default.red("[配置错误]分包["+r.name+"] root 不存在")),_shelljs2.default.exit(1)}else console.log(_chalk2.default.red("[配置错误]分包配置必须包含name和root属性")),_shelljs2.default.exit(1)}),console.log(_chalk2.default.green("### 分包配置检查完成 ### 准备打包"))}function getExcludes(e,r,t,a){var l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"all",u=[];for(var s in r){var n=r[s];null!=e&&n.path==e.path||(u=u.concat(n[l])),_fsExtra2.default.statSync(n.path).isDirectory()&&u.push(n.path)}return a!=CONFIG.MAIN_PACK_NAME&&(u=u.concat(t[l])),u}function collectPackFiles(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t={path:e,all:[],js:[],other:[]};if(_fsExtra2.default.statSync(e).isDirectory()){var a=[];(0,_utils.traverseDirSync)(e,a,r),a.forEach(function(e){t.all.push(e),".js"==_path2.default.extname(e)?t.js.push(e):t.other.push(e)})}else r&&-1!=r.indexOf(e)||(t.all.push(e),t.js.push(e));return t}function mkDirs(e,r){var t=e,a=_path2.default.join(t,CONFIG.BUILD_PATH),l=_path2.default.join(t,CONFIG.DEST_DIR);_fsExtra2.default.emptyDirSync(l),_fsExtra2.default.emptyDirSync(a),console.log(_chalk2.default.green("[准备工作]build&dist 文件夹已清空"));var u=_path2.default.join(t,CONFIG.SIGN_DIR_NAME),s=_path2.default.resolve(_path2.default.resolve(__dirname,"../../sign"));_fsExtra2.default.existsSync(u)||(console.log(_chalk2.default.yellow("### 缺少签名文件 ### 使用默认签名和证书")),(0,_utils.copyFiles)(s,u));var n=r?CONFIG.SIGN_DEBUG_DIR:CONFIG.SIGN_RELEASE_DIR,o=_path2.default.join(u,n,CONFIG.PRIVATE_FILE_NAME),i=_path2.default.join(u,n,CONFIG.CERTIFICATE_FILE_NAME);return _fsExtra2.default.existsSync(o)&&_fsExtra2.default.existsSync(i)||(r?(console.log(_chalk2.default.yellow("### 缺少签名文件 ### 使用默认签名和证书")),(0,_utils.copyFiles)(_path2.default.join(s,n),_path2.default.join(u,n))):(console.log(_chalk2.default.red("[签名文件错误]没有 release 的签名和证书, 请保证以下路径的文件存在，私钥："+o+", 证书："+i)),_shelljs2.default.exit(1))),{signFiles:{privatekey:o,certificate:i},targetDir:a,distDir:l}}function getExposeName(e){return _path2.default.posix.sep+_path2.default.relative(process.cwd(),e).split(_path2.default.win32.sep).join(_path2.default.posix.sep)}function createBundle(e,r){var t={debug:!1,insertGlobals:!1,externalRequireName:"__require__",prelude:prelude,preludePath:preludePath,paths:[]};return _fsExtra2.default.statSync(r).isDirectory()?t.paths.push(r):t.paths.push(_path2.default.dirname(r)),e&&(t=(0,_assign2.default)(t,{})),(0,_browserify2.default)(t)}function checkProject(e){var r=null,t=["manifest.json","main.js"];t.forEach(function(r){var t=_path2.default.join(e,r);_fsExtra2.default.existsSync(t)||(console.log(_chalk2.default.red("[错误]缺少文件 "+r+", 确保改路径下文件存在："+t)),_shelljs2.default.exit(1))});var a=_path2.default.join(e,t[0]);try{r=require(a)}catch(e){console.log(_chalk2.default.red("[error]parse config file error: "+a)),_shelljs2.default.exit(1)}if(r){var l=/^[a-zA-Z]+[0-9a-zA-Z_]*(\.[a-zA-Z]+[0-9a-zA-Z_]*)*$/;r.package?l.test(r.package)||(console.log(_chalk2.default.red("[配置错误]包名不合法")),_shelljs2.default.exit(1)):(console.log(_chalk2.default.red("[配置错误]必须包含包名")),_shelljs2.default.exit(1))}return r}Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildDir=exports.signDir=void 0;var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),signDir=exports.signDir=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,a,l,u,s){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new _promise2.default(function(e,n){var o=r||l.package;console.log(_chalk2.default.green("### 开始签名rpk ###: "+o)),(0,_signer.sign)({input:t,output:a,rpkName:o,signFiles:u},s,function(r){console.log(_chalk2.default.green("### 完成签名rpk ###: "+r)),e()})}));case 1:case"end":return e.stop()}},e,this)}));return function(r,t,a,l,u,s){return e.apply(this,arguments)}}(),buildDir=exports.buildDir=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,a,l,u){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],n=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},o=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_fsExtra2.default.ensureDirSync(a),l&&(s.push(_path2.default.resolve(t,CONFIG.QUICKGAME_DIR)),s.push(_path2.default.resolve(t,CONFIG.SIGN_DIR_NAME)),s.push(_path2.default.resolve(t,CONFIG.BUILD_PATH)),s.push(_path2.default.resolve(t,CONFIG.DEST_DIR)),CONFIG.EXCLUDES.forEach(function(e){s.push(_path2.default.resolve(t,e))})),e.prev=2,!r){e.next=11;break}return console.log(_chalk2.default.green("### 开始构建js ### 包名： "+t)),e.next=7,buildJs(t,a,l,u,s,n,o);case 7:console.log(_chalk2.default.green("### js构建完成 ### 包名： "+t)),(0,_utils.copyFiles)(t,a,[".js"],s),e.next=12;break;case 11:(0,_utils.copyFiles)(t,a,[],s);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),console.log(_chalk2.default.red("### 构建js失败 ### "+e.t0));case 17:case"end":return e.stop()}},e,this,[[2,14]])}));return function(r,t,a,l,u){return e.apply(this,arguments)}}(),buildJs=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,a,l,u){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},n=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new _promise2.default(function(e,o){var i=_fsExtra2.default.statSync(r).isDirectory()?_path2.default.resolve(r)+"/**/*.js":r;(0,_globby2.default)([i]).then(function(i){var f=createBundle(l,r),_=CONFIG.MAIN_ENTRY_JS_NAME+".js";if(i.forEach(function(e){var r=_path2.default.basename(e,_path2.default.extname(e));s[r]&&s[r]!=e||(s[r]=e),f.require(e,{expose:getExposeName(e)}),!a&&l&&f.add(_path2.default.resolve(e),{expose:getExposeName(e)})}),a){var c=_path2.default.resolve(_path2.default.join(r,_));f.add(c,{expose:getExposeName(c)})}var p=[];u&&u.forEach(function(e){(-1==i.indexOf(e)||a)&&p.push(e)}),f=f.external(p).transform(_babelify2.default,{presets:[(0,_utils.loadBabelModule)("babel-preset-env")],generatorOpts:{compact:!1}}).bundle().on("error",function(e){console.log(_chalk2.default.red("[js编译错误]"+e)),o(e)}).pipe((0,_vinylSourceStream2.default)(_)).pipe((0,_vinylBuffer2.default)()),n&&(f=f.pipe(_gulpSourcemaps2.default.init({loadMaps:!1}))),n||(f=f.pipe((0,_gulpUglify2.default)({mangle:!1,compress:{sequences:!1,properties:!1,drop_debugger:!1,unsafe:!1,comparisons:!1,booleans:!1,typeofs:!1,loops:!1,unused:!1,hoist_funs:!1,hoist_props:!1,hoist_vars:!1,if_return:!1,inline:!1,join_vars:!1,collapse_vars:!1,reduce_funcs:!1,reduce_vars:!1,pure_getters:!1,pure_funcs:null,drop_console:!1,keep_fargs:!0,keep_fnames:!0,keep_infinity:!0,side_effects:!1}}))),f.pipe(_gulp2.default.dest(t)).on("end",function(){e()})})}));case 1:case"end":return e.stop()}},e,this)}));return function(r,t,a,l,u){return e.apply(this,arguments)}}();exports.checkSubpackageConf=checkSubpackageConf,exports.getExcludes=getExcludes,exports.collectPackFiles=collectPackFiles,exports.mkDirs=mkDirs,exports.checkProject=checkProject;var _path=require("path"),_path2=_interopRequireDefault(_path),_fsExtra=require("fs-extra"),_fsExtra2=_interopRequireDefault(_fsExtra),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_shelljs=require("shelljs"),_shelljs2=_interopRequireDefault(_shelljs),_browserify=require("browserify"),_browserify2=_interopRequireDefault(_browserify),_globby=require("globby"),_globby2=_interopRequireDefault(_globby),_babelify=require("babelify"),_babelify2=_interopRequireDefault(_babelify),_gulp=require("gulp"),_gulp2=_interopRequireDefault(_gulp),_vinylSourceStream=require("vinyl-source-stream"),_vinylSourceStream2=_interopRequireDefault(_vinylSourceStream),_vinylBuffer=require("vinyl-buffer"),_vinylBuffer2=_interopRequireDefault(_vinylBuffer),_gulpSourcemaps=require("gulp-sourcemaps"),_gulpSourcemaps2=_interopRequireDefault(_gulpSourcemaps),_gulpUglify=require("gulp-uglify"),_gulpUglify2=_interopRequireDefault(_gulpUglify),_signer=require("../sign/signer"),_config=require("../config/config"),CONFIG=_interopRequireWildcard(_config),_utils=require("../utils"),preludePath=_path2.default.resolve(__dirname,"../../prelude/browserify_prelude_src.js"),prelude=_fsExtra2.default.readFileSync(preludePath,"utf8");